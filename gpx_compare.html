<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPX Comparison Tool (Distance Profile)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script src="https://unpkg.com/gpxparser@3.0.7/dist/gpxparser.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 1200px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        h1, h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        #fileInput { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; display: block; width: 100%; box-sizing: border-box; }
        #chartContainer { width: 100%; height: 400px; margin-bottom: 30px; }
        #statsTable { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #statsTable th, #statsTable td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        #statsTable th { background-color: #007bff; color: white; }
        #statsTable tr:nth-child(even) { background-color: #f2f2f2; }
        .error-message { color: #d9534f; padding: 10px; border: 1px solid #d9534f; background-color: #fdd; margin-bottom: 15px; border-radius: 4px; }
        .loading-message { text-align: center; font-style: italic; color: #555; }
    </style>
</head>
<body>

    <div class="container">
        <h1>⛰️ GPX Elevation Profile (Distance)</h1>

        <input type="file" id="fileInput" multiple accept=".gpx">
        <div id="statusMessage" class="loading-message" style="display:none;">Parsing files...</div>

        <div id="noGpxError" class="error-message" style="display:none;">
            **Error:** The GPXParser library failed to load. Please check your internet connection or use a local copy of the library.
        </div>

        <h2>Elevation Profile (Distance vs. Elevation)</h2>
        <div id="chartContainer">
            <canvas id="elevationChart"></canvas>
        </div>

        <h2>Summary Statistics</h2>
        <table id="statsTable">
            <thead>
                <tr>
                    <th>File Name</th>
                    <th>Total Distance (km)</th>
                    <th>Elevation Gain (m)</th>
                    <th>Duration (hrs:min)</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="4">Select one or more GPX files (.gpx) to compare.</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('fileInput');
            const statsTableBody = document.querySelector('#statsTable tbody');
            const chartCanvas = document.getElementById('elevationChart');
            const statusMessage = document.getElementById('statusMessage');
            const noGpxError = document.getElementById('noGpxError');
            let elevationChart;

            // Check if the gpxParser class is defined
            if (typeof gpxParser === 'undefined') {
                noGpxError.style.display = 'block';
                return;
            }
            noGpxError.style.display = 'none';

            /**
             * Parses the GPX file content, extracts stats, and prepares data for 
             * an Elevation vs. Distance chart.
             * * @param {string} fileName - The name of the file.
             * @param {string} gpxContent - The XML content of the GPX file.
             * @returns {object} Parsed GPX data including stats and chart data.
             */
            function parseGpx(fileName, gpxContent) {
                const gpx = new gpxParser();
                
                try {
                    gpx.parse(gpxContent);
                } catch (e) {
                    console.error(`Error parsing ${fileName}:`, e);
                    throw new Error(`Invalid GPX format or missing data in ${fileName}`);
                }

                const track = gpx.tracks[0];
                if (!track || !track.points || track.points.length < 2) {
                    throw new Error(`No valid track data found in ${fileName}.`);
                }

                // 1. Total Distance and Elevation Gain (from gpx object stats)
                const distanceKm = (gpx.distance.total / 1000).toFixed(2);
                const elevationGainMeters = Math.floor(gpx.elevation.pos); 

                // 2. Duration (calculated from first and last point timestamps)
                const startTime = track.points[0].time;
                const endTime = track.points[track.points.length - 1].time;
                const durationMs = new Date(endTime).getTime() - new Date(startTime).getTime();
                const durationHoursTotal = durationMs / (1000 * 60 * 60);

                const hours = Math.floor(durationHoursTotal);
                const minutes = Math.floor((durationHoursTotal - hours) * 60);
                const formattedDuration = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;

                // 3. Chart Data: Elevation vs. Distance (in km)
                // We need to calculate cumulative distance for each point.
                let cumulativeDistanceMeters = 0;
                let previousPoint = track.points[0];

                const chartData = track.points.map((point) => {
                    // GPXParser.js provides helper functions, but distance calculation 
                    // between points is often not provided as a cumulative array.
                    // We calculate it manually using the gpx.getDistanceBetween helper.
                    
                    if (point !== previousPoint) {
                        // Calculate distance from the previous point in meters
                        const distSegment = gpx.getDistanceBetween({
                            lat: previousPoint.lat,
                            lon: previousPoint.lon
                        }, {
                            lat: point.lat,
                            lon: point.lon
                        });
                        cumulativeDistanceMeters += distSegment;
                    }
                    
                    previousPoint = point;

                    return {
                        x: cumulativeDistanceMeters / 1000, // Distance in kilometers
                        y: point.ele // Elevation in meters
                    };
                });

                return {
                    name: fileName,
                    distance: distanceKm,
                    elevationGain: elevationGainMeters,
                    duration: formattedDuration,
                    chartData: chartData,
                };
            }

            // --- Charting Logic ---
            function updateChart(gpxDataArray) {
                const colors = [
                    'rgba(0, 123, 255, 1)',  // Blue
                    'rgba(40, 167, 69, 1)',  // Green
                    'rgba(255, 193, 7, 1)',  // Yellow
                    'rgba(220, 53, 69, 1)',  // Red
                    'rgba(111, 66, 193, 1)', // Purple
                    'rgba(23, 162, 184, 1)'  // Cyan
                ];

                const datasets = gpxDataArray.map((gpx, index) => ({
                    label: gpx.name,
                    data: gpx.chartData,
                    borderColor: colors[index % colors.length],
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    parsing: {
                        xAxisKey: 'x', // Distance in km
                        yAxisKey: 'y'  // Elevation in meters
                    }
                }));

                const data = { datasets };

                const config = {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'linear',
                                title: {
                                    display: true,
                                    // UPDATED X-AXIS LABEL
                                    text: 'Distance (Kilometers)' 
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Elevation (Meters)'
                                },
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    // UPDATED TOOLTIP LABEL
                                    title: (context) => `Distance: ${context[0].parsed.x.toFixed(2)} km`,
                                    label: (context) => `${context.dataset.label}: ${context.parsed.y} m`
                                }
                            }
                        }
                    }
                };

                if (elevationChart) {
                    elevationChart.destroy();
                }

                elevationChart = new Chart(chartCanvas, config);
            }

            // --- Statistics Table Logic (Unchanged) ---
            function updateStatsTable(gpxDataArray) {
                statsTableBody.innerHTML = '';
                if (gpxDataArray.length === 0) {
                    statsTableBody.innerHTML = '<tr><td colspan="4">No data to display.</td></tr>';
                    return;
                }
                gpxDataArray.forEach(gpx => {
                    const row = statsTableBody.insertRow();
                    row.insertCell().textContent = gpx.name;
                    row.insertCell().textContent = gpx.distance;
                    row.insertCell().textContent = gpx.elevationGain;
                    row.insertCell().textContent = gpx.duration;
                });
            }

            // --- File Handling Logic (Unchanged) ---
            function handleFiles(event) {
                document.querySelectorAll('.error-message').forEach(el => {
                    if (el.id !== 'noGpxError') el.remove();
                });

                const files = event.target.files;
                if (files.length === 0) {
                    statsTableBody.innerHTML = '<tr><td colspan="4">Select one or more GPX files (.gpx) to compare.</td></tr>';
                    if (elevationChart) elevationChart.destroy();
                    return;
                }
                
                statusMessage.style.display = 'block';
                statsTableBody.innerHTML = '';
                
                const parsedGpxData = [];
                let filesProcessed = 0;

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        try {
                            const gpxContent = e.target.result;
                            const data = parseGpx(file.name, gpxContent); 
                            parsedGpxData.push(data);
                        } catch (error) {
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'error-message';
                            errorDiv.textContent = `Error processing ${file.name}: ${error.message}`;
                            document.querySelector('.container').insertBefore(errorDiv, statusMessage.nextSibling);
                        } finally {
                            filesProcessed++;
                            if (filesProcessed === files.length) {
                                statusMessage.style.display = 'none';
                                updateChart(parsedGpxData);
                                updateStatsTable(parsedGpxData);
                            }
                        }
                    };

                    reader.onerror = () => {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'error-message';
                        errorDiv.textContent = `Failed to read file: ${file.name}`;
                        document.querySelector('.container').insertBefore(errorDiv, statusMessage.nextSibling);
                        filesProcessed++;
                        if (filesProcessed === files.length) {
                             statusMessage.style.display = 'none';
                             updateChart(parsedGpxData);
                             updateStatsTable(parsedGpxData);
                        }
                    };

                    reader.readAsText(file);
                }
            }

            fileInput.addEventListener('change', handleFiles);
        });
    </script>
</body>
</html>
